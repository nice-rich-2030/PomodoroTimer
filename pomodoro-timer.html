<!--
Copyright (c) 2025 Daily Growth
https://yourworklifedesign.blogspot.com/
All rights reserved.
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState</title>
    <style>
        :root {
            --primary-color: #ff6347;
            --secondary-color: #4caf50;
            --background-color: #ffffff;
            --text-color: #333333;
            --card-background: #f5f5f5;
            --border-color: #dddddd;
            --completed-color: #888888;
            --progress-bg: #eeeeee;
        }

        [data-theme="dark"] {
            --primary-color: #ff7f6e;
            --secondary-color: #5cca60;
            --background-color: #1f1f1f;
            --text-color: #f0f0f0;
            --card-background: #2d2d2d;
            --border-color: #444444;
            --completed-color: #aaaaaa;
            --progress-bg: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            grid-gap: 20px;
            height: calc(100vh - 40px);
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1600px) {
            .container {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }

        .title {
            font-size: clamp(24px, 3vw, 48px);
            font-weight: bold;
            color: var(--primary-color);
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .timer-section {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .circle-progress {
            position: relative;
            width: clamp(200px, 30vw, 400px);
            height: clamp(200px, 30vw, 400px);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle-progress svg {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .circle-background {
            fill: none;
            stroke: var(--progress-bg);
            stroke-width: 15;
        }

        .circle-progress-bar {
            fill: none;
            stroke: var(--primary-color);
            stroke-width: 15;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s;
        }

        .time-display {
            position: absolute;
            font-size: clamp(36px, 5vw, 72px);
            font-weight: bold;
            color: var(--primary-color);
        }

        .status {
            font-size: clamp(18px, 2vw, 24px);
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(255, 99, 71, 0.5);
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 5px rgba(255, 99, 71, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(255, 99, 71, 0.8), 0 0 20px rgba(255, 99, 71, 0.5);
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 12px 24px;
            font-size: clamp(14px, 1.5vw, 18px);
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            min-width: 100px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-color);
        }

        .counter {
            font-size: clamp(14px, 1.5vw, 18px);
            margin-top: 20px;
        }

        .settings {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .settings h2 {
            font-size: clamp(18px, 2vw, 24px);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(100, 100, 255, 0.5);
            animation: settings-glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes settings-glow {
            from {
                text-shadow: 0 0 5px rgba(100, 100, 255, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(100, 100, 255, 0.8), 0 0 20px rgba(100, 100, 255, 0.5);
            }
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .setting-group input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .time-display-small {
            font-size: clamp(14px, 1.5vw, 18px);
            font-weight: bold;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .preset-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .tasks-section {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .tasks-section h2 {
            font-size: clamp(18px, 2vw, 24px);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            animation: task-glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes task-glow {
            from {
                text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(76, 175, 80, 0.8), 0 0 20px rgba(76, 175, 80, 0.5);
            }
        }

        .task-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .task-input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .pomodoro-count {
            width: 60px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
            text-align: center;
        }

        .task-list {
            list-style-type: none;
            overflow-y: auto;
            flex: 1;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: var(--background-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid transparent;
        }

        .task-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .task-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }
        
        .task-item.active {
            border-left: 4px solid var(--primary-color);
            background-color: rgba(255, 99, 71, 0.1);
            box-shadow: 0 0 12px rgba(255, 99, 71, 0.2);
        }

        .task-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-text {
            flex: 1;
            font-size: 16px;
            transition: color 0.2s, text-decoration 0.2s;
        }

        .task-completed .task-text {
            color: var(--completed-color);
            text-decoration: line-through;
        }

        .task-drag-handle {
            cursor: grab;
            padding: 5px;
            margin-right: 10px;
            color: var(--border-color);
        }

        .task-pomodoro-counter {
            display: flex;
            align-items: center;
            margin-right: 15px;
            font-size: 14px;
        }

        .task-delete {
            background: none;
            border: none;
            color: #ff0000;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            font-size: 18px;
        }

        .task-delete:hover {
            opacity: 1;
        }

        .task-stats {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .hide-completed {
            margin-top: 10px;
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
        }

        .focus-mode-toggle {
            margin-top: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .focus-mode-toggle input {
            margin-right: 8px;
        }

        .statistics-section {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .statistics-section h2 {
            font-size: clamp(18px, 2vw, 24px);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            animation: stats-glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes stats-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(255, 193, 7, 0.8), 0 0 20px rgba(255, 193, 7, 0.5);
            }
        }

        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .chart-container {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }

        @media (max-width: 767px) {
            .container {
                height: auto;
            }
            
            .timer-section,
            .tasks-section,
            .statistics-section {
                min-height: auto;
            }
            
            .task-list {
                max-height: 300px;
            }
        }

        /* Focus Mode */
        body.focus-mode .tasks-section,
        body.focus-mode .statistics-section {
            display: none;
        }

        body.focus-mode .container {
            grid-template-columns: 1fr;
        }

        body.focus-mode .timer-section {
            height: calc(100vh - 120px);
        }
		.chart-toggle {
		  display: flex;
		  justify-content: center;
		  margin-bottom: 10px;
		}

		.chart-toggle-btn {
		  padding: 5px 10px;
		  margin: 0 5px;
		  border: 1px solid var(--border-color);
		  border-radius: 4px;
		  background-color: transparent;
		  color: var(--text-color);
		  cursor: pointer;
		  transition: background-color 0.2s;
		}

		.chart-toggle-btn.active {
		  background-color: var(--primary-color);
		  color: white;
		}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">FlowState</h1>
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle">
                <span class="slider"></span>
            </label>
        </header>

        <section class="timer-section">
            <div class="circle-progress">
                <svg>
                    <circle class="circle-background" cx="50%" cy="50%" r="45%" />
                    <circle class="circle-progress-bar" cx="50%" cy="50%" r="45%" />
                </svg>
                <div class="time-display">25:00</div>
            </div>
            <div class="status">作業</div>
            <div class="controls">
                <button class="btn btn-primary" id="start-btn">▶️スタート</button>
                <button class="btn btn-secondary" id="pause-btn" disabled>⏸️ポーズ</button>
                <button class="btn btn-outline" id="reset-btn">🔁 リセット</button>
            </div>
            <div class="counter">完了した累積ポモドーロ: <span id="pomodoro-count">0</span></div>

            <div class="settings">
                <h2 class="settings-title">⚙️ 設定</h2>
                <div class="setting-group">
                    <label for="work-time">🔥作業時間: <span id="work-time-display">25</span>分</label>
                    <input type="range" id="work-time" min="1" max="60" value="25">
                </div>
                <div class="setting-group">
                    <label for="break-time">☕休憩時間: <span id="break-time-display">5</span>分</label>
                    <input type="range" id="break-time" min="1" max="30" value="5">
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-work="15" data-break="5">15/5</button>
                    <button class="preset-btn" data-work="25" data-break="5">25/5</button>
                    <button class="preset-btn" data-work="40" data-break="10">40/10</button>
                    <button class="preset-btn" data-work="50" data-break="10">50/10</button>
                </div>
                <div class="focus-mode-toggle">
                    <input type="checkbox" id="focus-mode"> <label for="focus-mode">集中モード</label>
                </div>
            </div>
        </section>

        <section class="tasks-section">
            <h2>📝 タスクリスト</h2>
            <form id="task-form" class="task-form">
                <input type="text" id="task-input" class="task-input" placeholder="新しいタスクを入力..." required>
                <input type="number" id="pomodoro-count-input" class="pomodoro-count" min="1" value="1"
                    title="予定ポモドーロ数">
                <button type="submit" class="btn btn-primary">➕ 追加</button>
            </form>
            <ul id="task-list" class="task-list"></ul>
            <div class="task-stats">
                <p>全タスク: <span id="total-tasks">0</span> / 完了: <span id="completed-tasks">0</span></p>
                <button class="hide-completed" id="toggle-completed">👁️ 完了したタスクを表示/非表示</button>
            </div>
        </section>

        <section class="statistics-section">
            <h2 class="statistics-title">📊 統計</h2>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="today-pomodoros">0</div>
                    <div class="stat-label">本日のポモドーロ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-time">0</div>
                    <div class="stat-label">本日の集中時間 (分)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-tasks-count">0</div>
                    <div class="stat-label">完了したタスク</div>
                </div>
            </div>
            <div class="chart-container">
				<div class="chart-toggle">
				  <button id="show-pomodoros" class="chart-toggle-btn active">🍅 ポモドーロ数</button>
				  <button id="show-focus-time" class="chart-toggle-btn">⏱️ 集中時間</button>
				</div>
                <!-- ここに週間グラフが表示される -->
                <svg id="weekly-chart" width="100%" height="100%"></svg>
            </div>
        </section>
    </div>

    <audio id="notification-sound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBhxQo/T/xHQrChs2e9f6zHg9CgoPHF7O/+GaTgcDAwtHuvj/qlMBAAMGM6Xo/8JmCAAAAyBsx+3/pGkhAQUKDi5p4Pv/owEACA8cJjWQ7///VwIBDRs2WvL//5FaKBMlLDxP4f//mzUEChYwM0ro//+uXiMSFiUb/fT8yxcY4bbc//oJ/iRXweDl+A0VCycrVrXq/v8RBQkbKkWm4/7/EgMBAwkNVI/q//8vDwEAAgQ3qff//1ASAQABBSOBzvn/cFILAgEDD2vT//94Mg0FBAkQf+r//11DBQMFCxmJ7f/qvksyWs7//wsWIzFTu/P//x4LEApXpuD6/yYGEA8gSfr//4ogDAYHDh1FzvH//1sLBAQHDW3z//9oHQoEBAcea9X//2YhCwUFCRqO6v//ZhsIAwQILvL//3EcBAEBBET//5kyBgIAAgZL6P//3mphco+gemo0FICjromPfWthYHOJnp9MBj1qusjBiWA9THTY//+SOQEVVbLc5fJJIRUySbPc6PgtEBQjL2C/4O76Jw0PIzFVmdnw/DIQDxgfL7Hf//k+EAwUISEvsOL//ogZBQACA1OL1Pv/chgGAAADQLPu//9mGgYAAAY0ltv//2oZBQABBy3Q/P//cRIFAAIZhdT//3YaBwEABC/j//+EGQIBAgxb1f//aRgDAwMOitL//2AXBAUGGvL//2AcBgICCkno//9wGgQCAgdR4f//bxcDAQMRrN3//0sZCQQEB1TN//9CGgkEBART4f//TBsGAwURgdz//0kaCAgJFX/j//9LIxYQEhGC5v//VDIhGRoVe+X//1pGMCoqHpnw//9DMjY0Jj7a//9iY1JJSzq9//++d0tGRD2L+f//kHcAAAABAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAMAAAAAAAAAAAAAAAAAAAAEAAAAAQAAAAAAAAAAAAAABQAAAAIAAAAAAAAAAAAABgAAAAMAAAAAAAAAAAAABwAAAAQAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAQAAAAEAAAABAAAAAQAAAAIAAAACAAAAAgAAAAIAAAADAAAAAwAAAAMAAAADAAAABAAAAAQAAAAEAAAABAAAYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const timeDisplay = document.querySelector('.time-display');
            const statusDisplay = document.querySelector('.status');
            const pomodoroCountDisplay = document.getElementById('pomodoro-count');
            const circleProgress = document.querySelector('.circle-progress-bar');
            const workTimeSlider = document.getElementById('work-time');
            const breakTimeSlider = document.getElementById('break-time');
            const workTimeDisplay = document.getElementById('work-time-display');
            const breakTimeDisplay = document.getElementById('break-time-display');
            const themeToggle = document.getElementById('theme-toggle');
            const presetButtons = document.querySelectorAll('.preset-btn');
            const taskForm = document.getElementById('task-form');
            const taskInput = document.getElementById('task-input');
            const pomodoroCountInput = document.getElementById('pomodoro-count-input');
            const taskList = document.getElementById('task-list');
            const totalTasksDisplay = document.getElementById('total-tasks');
            const completedTasksDisplay = document.getElementById('completed-tasks');
            const toggleCompletedBtn = document.getElementById('toggle-completed');
            const focusModeToggle = document.getElementById('focus-mode');
            const notificationSound = document.getElementById('notification-sound');
            const todayPomodorosDisplay = document.getElementById('today-pomodoros');
            const totalTimeDisplay = document.getElementById('total-time');
            const completedTasksCountDisplay = document.getElementById('completed-tasks-count');
            const weeklyChart = document.getElementById('weekly-chart');
			const showPomodorosBtn = document.getElementById('show-pomodoros');
			const showFocusTimeBtn = document.getElementById('show-focus-time');
			let chartDisplayMode = 'pomodoros'; // デフォルト表示モード

            // Timer State
            let timer = {
                workTime: 25 * 60, // 25分（秒単位）
                breakTime: 5 * 60,  // 5分（秒単位）
                currentTime: 25 * 60,
                isRunning: false,
                interval: null,
                mode: 'work', // 'work' or 'break'
                pomodoroCount: 0
            };

			// 1. statsオブジェクトの構造変更
			let stats = {
			    completedTasks: 0,
			    // weeklyDataの構造を変更
			    weeklyData: [] // 過去のデータを {date: "YYYY-MM-DD", pomodoros: 0, focusTime: 0} 形式で保存
			};

            // Tasks
            let tasks = [];
            let hideCompleted = false;
            
            // グローバルスコープでインターバルIDを保持する変数
			let dateCheckIntervalId = null;

			// 2. 日付チェック関数の修正
			function checkDateChange() {
			    const today = new Date().toDateString();
			    const todayFormatted = formatDateYMD(new Date()); // YYYY-MM-DD形式の日付
			    const lastDate = localStorage.getItem('pomodoroLastDate');
			    console.log("checkDateChange lastDate:",lastDate);
			    console.log("checkDateChange today:",today);
			    if (lastDate !== today) {
			        // 前回の日付がある場合、新しいエントリを追加
			        const todayEntry = stats.weeklyData.find(entry => entry.date === todayFormatted);
			        
			        if (!todayEntry) {
			            // 今日のエントリがまだなければ、新しいエントリを追加
			            stats.weeklyData.unshift({
			                date: todayFormatted,
			                pomodoros: 0,
			                focusTime: 0
			            });
			            
			            // 7日分以上あれば古いものを削除
			            while (stats.weeklyData.length > 7) {
			                stats.weeklyData.pop();
			            }
			        }
			        
			        // 最終日付を更新
			        localStorage.setItem('pomodoroLastDate', today);
			        
			        // 統計表示を更新
			        updateStatisticsDisplay();
			        drawWeeklyChart();
    			    console.log("checkDateChange ○　update!:");
			    }else{
    			    console.log("checkDateChange ×no update:");
			    }
			}

			// 3. 日付をYYYY-MM-DD形式にフォーマットする関数の追加
			function formatDateYMD(date) {
			    const year = date.getFullYear();
			    const month = String(date.getMonth() + 1).padStart(2, '0');
			    const day = String(date.getDate()).padStart(2, '0');
			    return `${year}-${month}-${day}`;
			}
			
            // ローカルストレージからデータを読み込む
            function loadFromLocalStorage() {
                // タイマー設定
                const savedSettings = JSON.parse(localStorage.getItem('pomodoroSettings'));
                if (savedSettings) {
                    timer.workTime = savedSettings.workTime;
                    timer.breakTime = savedSettings.breakTime;
                    workTimeSlider.value = timer.workTime / 60;
                    breakTimeSlider.value = timer.breakTime / 60;
                    workTimeDisplay.textContent = timer.workTime / 60;
                    breakTimeDisplay.textContent = timer.breakTime / 60;
                }

                // タスク
                const savedTasks = JSON.parse(localStorage.getItem('pomodoroTasks'));
                if (savedTasks) {
                    tasks = savedTasks;
                    renderTasks();
                }

			    // 統計
			    const savedStats = JSON.parse(localStorage.getItem('pomodoroStats'));
			    if (savedStats) {
			        stats = savedStats;
			    } else {
			        // 初期データがない場合は作成
			        const today = formatDateYMD(new Date());
			        stats = {
			            completedTasks: 0,
			            weeklyData: [{
			                date: today,
			                pomodoros: 0,
			                focusTime: 0
			            }]
			        };
			        localStorage.setItem('pomodoroLastDate', new Date().toDateString());
			    }
                // テーマ
                const darkMode = localStorage.getItem('pomodoroDarkMode') === 'true';
                themeToggle.checked = darkMode;
                if (darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }

                // ポモドーロカウント
                timer.pomodoroCount = parseInt(localStorage.getItem('pomodoroCount') || '0');
                pomodoroCountDisplay.textContent = timer.pomodoroCount;

            }

            // ローカルストレージにデータを保存
            function saveToLocalStorage() {
                // タイマー設定
                localStorage.setItem('pomodoroSettings', JSON.stringify({
                    workTime: timer.workTime,
                    breakTime: timer.breakTime
                }));

                // タスク
                localStorage.setItem('pomodoroTasks', JSON.stringify(tasks));

                // 統計
                localStorage.setItem('pomodoroStats', JSON.stringify(stats));
                //localStorage.setItem('pomodoroLastDate', new Date().toDateString());

                // テーマ
                localStorage.setItem('pomodoroDarkMode', themeToggle.checked);

                // ポモドーロカウント
                localStorage.setItem('pomodoroCount', timer.pomodoroCount);
            }

            // 日付フォーマット関数
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // タイマー更新関数
            function updateTimer() {
                if (timer.currentTime > 0) {
                    timer.currentTime--;
                    timeDisplay.textContent = formatTime(timer.currentTime);
                    
                    // プログレスバー更新
                    const totalTime = timer.mode === 'work' ? timer.workTime : timer.breakTime;
                    const circumference = 2 * Math.PI * parseFloat(circleProgress.getAttribute('r'));
                    const offset = circumference - (timer.currentTime / totalTime) * circumference;
                    circleProgress.style.strokeDasharray = `${circumference} ${circumference}`;
                    circleProgress.style.strokeDashoffset = offset;
                } else {
                    // タイマー終了
                    clearInterval(timer.interval);
                    timer.isRunning = false;
                    //notificationSound.play();
                    // 通知を表示
                    notifyTimerEnd();
					// タイマー更新関数内のポモドーロ完了時の処理を変更
					// updateTimer関数内の該当部分を変更
					if (timer.mode === 'work') {
					    // 作業モードが終了した場合
					    timer.mode = 'break';
					    timer.currentTime = timer.breakTime;
					    statusDisplay.textContent = '休憩';
					    statusDisplay.style.color = 'var(--secondary-color)';
					    circleProgress.style.stroke = 'var(--secondary-color)';
					    timer.pomodoroCount++;
					    pomodoroCountDisplay.textContent = timer.pomodoroCount;
					    
					    // 統計更新
					    const today = formatDateYMD(new Date());
					    // 今日のデータがあるか確認
					    let todayEntry = stats.weeklyData.find(entry => entry.date === today);
					    
					    if (!todayEntry) {
					        // 今日のエントリがなければ追加
					        todayEntry = {
					            date: today,
					            pomodoros: 0,
					            focusTime: 0
					        };
					        stats.weeklyData.unshift(todayEntry);
					        
					        // 7日分以上あれば古いものを削除
					        while (stats.weeklyData.length > 7) {
					            stats.weeklyData.pop();
					        }
					    }
					    
					    // 今日のデータを更新
					    todayEntry.pomodoros++;
					    todayEntry.focusTime += timer.workTime / 60;
					    
					    updateStatisticsDisplay();
					    drawWeeklyChart();
					    
					    // 選択されているタスクのポモドーロカウントを更新
					    updateTaskPomodoro();
					} else {
                        // 休憩モードが終了した場合
                        timer.mode = 'work';
                        timer.currentTime = timer.workTime;
                        statusDisplay.textContent = '作業';
                        statusDisplay.style.color = 'var(--primary-color)';
                        circleProgress.style.stroke = 'var(--primary-color)';
                    }
                    
                    timeDisplay.textContent = formatTime(timer.currentTime);
                    startBtn.disabled = false;
                    pauseBtn.disabled = true;
                    
                    saveToLocalStorage();
                }
            }

            // 選択されているタスクのポモドーロカウントを更新
            function updateTaskPomodoro() {
                const activeTaskItem = document.querySelector('.task-item.active');
                if (activeTaskItem) {
                    const taskId = activeTaskItem.dataset.id;
                    const taskIndex = tasks.findIndex(task => task.id === taskId);
                    
                    if (taskIndex !== -1) {
                        tasks[taskIndex].completedPomodoros = (tasks[taskIndex].completedPomodoros || 0) + 1;
                        renderTasks();
                        saveToLocalStorage();
                    }
                }
            }

			// アプリ起動時に日付チェック用のインターバルを設定
			function setupDateChangeChecker() {
			    // すでに設定されている場合はクリア
			    if (dateCheckIntervalId !== null) {
			        clearInterval(dateCheckIntervalId);
			    }
  			    // 1分ごとに日付変更をチェック
			    setInterval(checkDateChange, 60000);
			}
            // タイマー開始関数
            function startTimer() {
                if (!timer.isRunning) {
                    timer.isRunning = true;
                    timer.interval = setInterval(updateTimer, 1000);
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    if (timer.mode === 'work') {
                        statusDisplay.textContent = '🔥作業中';
                    }else{
                        statusDisplay.textContent = '☕休憩中';
                    }
                }
            }

            // タイマー一時停止関数
            function pauseTimer() {
                if (timer.isRunning) {
                    timer.isRunning = false;
                    clearInterval(timer.interval);
                    startBtn.disabled = false;
                    pauseBtn.disabled = true;
                    if (timer.mode === 'work') {
                        statusDisplay.textContent = '停止中(作業)';
                    }else{
                        statusDisplay.textContent = '停止中(休憩)';
                    }
                }
            }

            // タイマーリセット関数
            function resetTimer() {
                pauseTimer();
                timer.mode = 'work';
                timer.currentTime = timer.workTime;
                timeDisplay.textContent = formatTime(timer.currentTime);
                statusDisplay.textContent = '作業';
                statusDisplay.style.color = 'var(--primary-color)';
                circleProgress.style.stroke = 'var(--primary-color)';
                
                // プログレスバーリセット
                const circumference = 2 * Math.PI * parseFloat(circleProgress.getAttribute('r'));
                circleProgress.style.strokeDasharray = `${circumference} ${circumference}`;
                circleProgress.style.strokeDashoffset = 0;
            }

            // タスク描画関数
            function renderTasks() {
                taskList.innerHTML = '';
                
                let tasksToRender = tasks;
                if (hideCompleted) {
                    tasksToRender = tasks.filter(task => !task.completed);
                }
                
                tasksToRender.forEach(task => {
                    const taskItem = document.createElement('li');
                    taskItem.className = 'task-item';
                    taskItem.dataset.id = task.id;
                    
                    if (task.completed) {
                        taskItem.classList.add('task-completed');
                    }
                    
                    taskItem.innerHTML = `
                        <div class="task-drag-handle">☰</div>
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <span class="task-text">${task.text}</span>
                        <div class="task-pomodoro-counter">
                            ${task.completedPomodoros || 0}/${task.plannedPomodoros} 🍅
                        </div>
                        <button class="task-delete">×</button>
                    `;
                    
                    // ドラッグイベント設定
                    taskItem.setAttribute('draggable', 'true');
                    taskItem.addEventListener('dragstart', handleDragStart);
                    taskItem.addEventListener('dragover', handleDragOver);
                    taskItem.addEventListener('drop', handleDrop);
                    taskItem.addEventListener('dragend', handleDragEnd);
                    
                    // チェックボックスイベント
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    checkbox.addEventListener('change', () => {
                        const taskId = taskItem.dataset.id;
                        const taskIndex = tasks.findIndex(t => t.id === taskId);
                        
                        if (taskIndex !== -1) {
                            tasks[taskIndex].completed = checkbox.checked;
                            
                            if (checkbox.checked) {
                                taskItem.classList.add('task-completed');
                                stats.completedTasks++;
                            } else {
                                taskItem.classList.remove('task-completed');
                                stats.completedTasks--;
                            }
                            
                            updateStatisticsDisplay();
                            updateTasksCounter();
                            saveToLocalStorage();
                        }
                    });
                    
                    // 削除ボタンイベント
                    const deleteBtn = taskItem.querySelector('.task-delete');
                    deleteBtn.addEventListener('click', () => {
                        const taskId = taskItem.dataset.id;
                        const taskIndex = tasks.findIndex(t => t.id === taskId);
                        
                        if (taskIndex !== -1) {
                            if (tasks[taskIndex].completed) {
                                stats.completedTasks--;
                            }
                            
                            tasks.splice(taskIndex, 1);
                            taskItem.remove();
                            updateTasksCounter();
                            updateStatisticsDisplay();
                            saveToLocalStorage();
                        }
                    });
                    
                    // タスク選択イベント
                    taskItem.addEventListener('click', (e) => {
                        // チェックボックスとボタンクリック以外の場合にアクティブにする
                        if (!e.target.classList.contains('task-checkbox') &&
                            !e.target.classList.contains('task-delete') &&
                            !e.target.classList.contains('task-drag-handle')) {
                            
                            document.querySelectorAll('.task-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            
                            taskItem.classList.add('active');
                        }
                    });
                    
                    taskList.appendChild(taskItem);
                });
                
                updateTasksCounter();
            }

            // タスクカウンター更新関数
            function updateTasksCounter() {
                totalTasksDisplay.textContent = tasks.length;
                const completedCount = tasks.filter(task => task.completed).length;
                completedTasksDisplay.textContent = completedCount;
            }

			// 6. 統計表示更新関数の修正
			function updateStatisticsDisplay() {
			    // 今日のデータを取得
			    const today = formatDateYMD(new Date());
			    const todayEntry = stats.weeklyData.find(entry => entry.date === today) || { pomodoros: 0, focusTime: 0 };
			    
			    todayPomodorosDisplay.textContent = todayEntry.pomodoros;
			    totalTimeDisplay.textContent = todayEntry.focusTime;
			    completedTasksCountDisplay.textContent = stats.completedTasks;
			}

            // ドラッグ＆ドロップ実装
            let draggedItem = null;

            function handleDragStart(e) {
                draggedItem = this;
                setTimeout(() => {
                    this.classList.add('dragging');
                }, 0);
                
                // データ転送オブジェクトの設定
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.dataset.id);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const target = e.target.closest('.task-item');
                if (target && target !== draggedItem) {
                    const targetRect = target.getBoundingClientRect();
                    const targetCenter = targetRect.top + (targetRect.height / 2);
                    
                    if (e.clientY < targetCenter) {
                        target.parentNode.insertBefore(draggedItem, target);
                    } else {
                        target.parentNode.insertBefore(draggedItem, target.nextSibling);
                    }
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                
                // タスク配列の順序も更新
                const newTasks = [];
                document.querySelectorAll('.task-item').forEach(item => {
                    const taskId = item.dataset.id;
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        newTasks.push(task);
                    }
                });
                
                tasks = newTasks;
                saveToLocalStorage();
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                draggedItem = null;
            }

			// 7. 週間チャート描画関数の修正 - 記録に残っている7回分を表示
			function drawWeeklyChart() {
			    const svg = weeklyChart;
			    svg.innerHTML = '';
			    
			    const width = svg.clientWidth;
			    const height = svg.clientHeight;
			    const padding = 40;
			    const chartWidth = width - (padding * 2);
			    const chartHeight = height - (padding * 2);

			    // 記録されているデータを日付順にソート
			    let chartData = [...stats.weeklyData].sort((a, b) => {
			        return new Date(b.date) - new Date(a.date);
			    });

			    // データがない場合は早期リターン
			    if (chartData.length === 0) {
			        // グラフがないことを示すメッセージを表示
			        const noDataText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
			        noDataText.setAttribute('x', width / 2);
			        noDataText.setAttribute('y', height / 2);
			        noDataText.setAttribute('text-anchor', 'middle');
			        noDataText.setAttribute('fill', 'var(--text-color)');
			        noDataText.setAttribute('font-size', '14');
			        noDataText.textContent = 'データがありません';
			        svg.appendChild(noDataText);
			        return;
			    }

			    // 最大7つまでのデータを使用
			    chartData = chartData.slice(0, 7);

			    // 各エントリに日付オブジェクトと表示用ラベルを追加
			    chartData.forEach(entry => {
			        entry.dateObj = new Date(entry.date);
			        entry.label = formatDateLabel(entry.dateObj);
			    });

				// 最大値を計算 (現在の表示モードに基づく)
				let maxValue;
				if (chartDisplayMode === 'pomodoros') {
				  maxValue = Math.max(...chartData.map(item => item.pomodoros), 1);
				} else {
				  maxValue = Math.max(...chartData.map(item => item.focusTime), 1);
				}
			    // バーの幅を計算
			    const barWidth = chartWidth / chartData.length;

			    // Y軸
			    const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
			    yAxis.setAttribute('x1', padding);
			    yAxis.setAttribute('y1', padding);
			    yAxis.setAttribute('x2', padding);
			    yAxis.setAttribute('y2', height - padding);
			    yAxis.setAttribute('stroke', 'var(--text-color)');
			    yAxis.setAttribute('stroke-width', '1');
			    svg.appendChild(yAxis);
			    
			    // X軸
			    const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
			    xAxis.setAttribute('x1', padding);
			    xAxis.setAttribute('y1', height - padding);
			    xAxis.setAttribute('x2', width - padding);
			    xAxis.setAttribute('y2', height - padding);
			    xAxis.setAttribute('stroke', 'var(--text-color)');
			    xAxis.setAttribute('stroke-width', '1');
			    svg.appendChild(xAxis);

			    // グラフのタイトル
			    const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
			    titleText.setAttribute('x', width / 2);
			    titleText.setAttribute('y', padding / 2);
			    titleText.setAttribute('text-anchor', 'middle');
			    titleText.setAttribute('fill', 'var(--primary-color)');
			    titleText.setAttribute('font-size', '14');
			    titleText.setAttribute('font-weight', 'bold');
				titleText.textContent = chartDisplayMode === 'pomodoros' ? 
				                         'ポモドーロ記録履歴' : '集中時間記録履歴 (分)';
				svg.appendChild(titleText);
				  
			    // バーとラベルを描画
			    chartData.forEach((item, index) => {
					// 表示モードに基づいて値を取得
					const value = chartDisplayMode === 'pomodoros' ? item.pomodoros : item.focusTime;
					const barHeight = value / maxValue * chartHeight;
					const x = padding + (index * barWidth);
			        const y = height - padding - barHeight;
			        
					// バーの色も表示モードによって変更
					const barColor = chartDisplayMode === 'pomodoros' ? 
					                'var(--primary-color)' : 'var(--secondary-color)';
                     // バー
			        const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
			        bar.setAttribute('x', x + 5);
			        bar.setAttribute('y', y);
			        bar.setAttribute('width', barWidth - 10);
			        bar.setAttribute('height', barHeight);
			        bar.setAttribute('fill', barColor);
			        bar.setAttribute('rx', '4');
			        svg.appendChild(bar);
			        
			        // 値ラベル
				    if (value > 0) {
				      const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
			            valueText.setAttribute('x', x + barWidth / 2);
			            valueText.setAttribute('y', y - 5);
			            valueText.setAttribute('text-anchor', 'middle');
			            valueText.setAttribute('fill', 'var(--text-color)');
			            valueText.setAttribute('font-size', '12');
			            valueText.textContent = value;
			            svg.appendChild(valueText);
			        }

			        // 日付と曜日を2行で表示
			        const dateLabel = item.label.split('\n');

			        // 日付ラベル (MM/DD)
			        const dateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
			        dateText.setAttribute('x', x + barWidth / 2);
			        dateText.setAttribute('y', height - padding + 15);
			        dateText.setAttribute('text-anchor', 'middle');
			        dateText.setAttribute('fill', 'var(--text-color)');
			        dateText.setAttribute('font-size', '12');
			        dateText.textContent = dateLabel[0]; // MM/DD部分
			        svg.appendChild(dateText);

			        // 曜日ラベル
			        const weekdayText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
			        weekdayText.setAttribute('x', x + barWidth / 2);
			        weekdayText.setAttribute('y', height - padding + 30);
			        weekdayText.setAttribute('text-anchor', 'middle');
			        weekdayText.setAttribute('fill', 'var(--text-color)');
			        weekdayText.setAttribute('font-size', '10');
			        weekdayText.textContent = dateLabel[1]; // (曜日)部分
			        svg.appendChild(weekdayText);
			    });
			}
            // 日付を「MM/DD」形式と曜日でフォーマットする関数
            function formatDateLabel(date) {
                const month = date.getMonth() + 1; // 月は0から始まるので+1
                const day = date.getDate();
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                const weekday = weekdays[date.getDay()];
                return `${month}/${day}\n(${weekday})`;
            }
            // イベントリスナー設定
            function setupEventListeners() {
                // タイマーコントロール
                startBtn.addEventListener('click', startTimer);
                pauseBtn.addEventListener('click', pauseTimer);
                resetBtn.addEventListener('click', resetTimer);
                
                // 作業時間スライダー
                workTimeSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    workTimeDisplay.textContent = value;
                    timer.workTime = value * 60;
                    
                    if (timer.mode === 'work' && !timer.isRunning) {
                        timer.currentTime = timer.workTime;
                        timeDisplay.textContent = formatTime(timer.currentTime);
                    }
                    
                    saveToLocalStorage();
                });
                
                // 休憩時間スライダー
                breakTimeSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    breakTimeDisplay.textContent = value;
                    timer.breakTime = value * 60;
                    
                    if (timer.mode === 'break' && !timer.isRunning) {
                        timer.currentTime = timer.breakTime;
                        timeDisplay.textContent = formatTime(timer.currentTime);
                    }
                    
                    saveToLocalStorage();
                });
                
                // テーマ切り替え
                themeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                    
                    saveToLocalStorage();
                });
                
                // プリセットボタン
                presetButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const workTime = parseInt(this.dataset.work);
                        const breakTime = parseInt(this.dataset.break);
                        
                        workTimeSlider.value = workTime;
                        breakTimeSlider.value = breakTime;
                        workTimeDisplay.textContent = workTime;
                        breakTimeDisplay.textContent = breakTime;
                        
                        timer.workTime = workTime * 60;
                        timer.breakTime = breakTime * 60;
                        
                        if (timer.mode === 'work' && !timer.isRunning) {
                            timer.currentTime = timer.workTime;
                            timeDisplay.textContent = formatTime(timer.currentTime);
                        } else if (timer.mode === 'break' && !timer.isRunning) {
                            timer.currentTime = timer.breakTime;
                            timeDisplay.textContent = formatTime(timer.currentTime);
                        }
                        
                        saveToLocalStorage();
                    });
                });
                
                // タスク追加フォーム
                taskForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const taskText = taskInput.value.trim();
                    const plannedPomodoros = parseInt(pomodoroCountInput.value) || 1;
                    
                    if (taskText) {
                        const newTask = {
                            id: Date.now().toString(),
                            text: taskText,
                            completed: false,
                            plannedPomodoros: plannedPomodoros,
                            completedPomodoros: 0,
                            createdAt: Date.now()
                        };
                        
                        tasks.push(newTask);
                        renderTasks();
                        saveToLocalStorage();
                        
                        taskInput.value = '';
                        pomodoroCountInput.value = '1';
                    }
                });
                
                // 完了タスク表示切り替え
                toggleCompletedBtn.addEventListener('click', function() {
                    hideCompleted = !hideCompleted;
                    renderTasks();
                });
                
                // 集中モード切り替え
                focusModeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('focus-mode');
                    } else {
                        document.body.classList.remove('focus-mode');
                    }
                });
                
                // ウィンドウリサイズ時にグラフ再描画
                window.addEventListener('resize', drawWeeklyChart);

				// イベントリスナーの追加
				showPomodorosBtn.addEventListener('click', function() {
				  chartDisplayMode = 'pomodoros';
				  showPomodorosBtn.classList.add('active');
				  showFocusTimeBtn.classList.remove('active');
				  drawWeeklyChart();
				});

				showFocusTimeBtn.addEventListener('click', function() {
				  chartDisplayMode = 'focusTime';
				  showFocusTimeBtn.classList.add('active');
				  showPomodorosBtn.classList.remove('active');
				  drawWeeklyChart();
				});
            }

            // SVGプログレスバー初期化
            function initProgressCircle() {
                const circle = document.querySelector('.circle-progress-bar');
                const radius = circle.getAttribute('r');
                const circumference = 2 * Math.PI * parseFloat(radius);
                
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = '0';
            }

            // アプリケーション初期化
            function init() {
                loadFromLocalStorage();
                initProgressCircle();
                resetTimer();
                setupEventListeners();
                setupDateChangeChecker();//日付チェックのタイマー設定
                renderTasks();
                updateStatisticsDisplay();
                drawWeeklyChart();
                
            }
            // タイマー終了時に呼び出す通知関数
            function notifyTimerEnd() {
                // 既存の音声通知
                //notificationSound.play();
                
                // デスクトップ通知を表示
                showNotification();
                
                // 画面をフラッシュさせる視覚的通知
                flashScreen();
            }

            // デスクトップ通知機能
            function showNotification() {
                // ローカルファイルかどうかをチェック
                if (location.protocol === 'file:') {
                    console.log('ローカル環境では通知は無効です');
                    return; // ローカル環境では通知をスキップ
                }
                // 通知の権限をチェック
                if (Notification.permission === "granted") {
                    // 通知を作成して表示
                    const notification = new Notification("FlowState", {
                        body: timer.mode === 'work' ? 
                            "作業時間が終了しました！休憩しましょう" : 
                            "休憩時間が終了しました！次の作業を始めましょう",
                        requireInteraction: true // ユーザーが操作するまで通知を消さない（Windows通知に効果的）
                    });
                    
                    // 通知をクリックしたときの処理
                    notification.onclick = function() {
                        window.focus(); // アプリケーションウィンドウにフォーカス
                        notification.close();
                    };
                } else if (Notification.permission !== "denied") {
                    // 通知の許可を求める
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            showNotification();
                        }
                    });
                }
            }

            // 画面フラッシュエフェクト
            function flashScreen() {
                // フラッシュ用のオーバーレイ要素を作成
                const overlay = document.createElement('div');
                overlay.id = 'flash-overlay';
                
                // スタイル設定
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = timer.mode === 'work' ? 
                    'rgba(255, 99, 71, 0.6)' : // 作業→休憩時は赤系
                    'rgba(76, 175, 80, 0.6)';  // 休憩→作業時は緑系
                overlay.style.zIndex = '9999';
                overlay.style.pointerEvents = 'none'; // クリックイベントを下の要素に通す
                
                // アニメーション用のスタイル要素を作成
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    @keyframes flash-animation {
                        0%, 100% { opacity: 0; }
                        25%, 75% { opacity: 1; }
                    }
                    #flash-overlay {
                        animation: flash-animation 1.2s ease-in-out 2;
                    }
                `;
                
                // 要素をDOMに追加
                document.head.appendChild(styleElement);
                document.body.appendChild(overlay);
                
                // アニメーション終了後に要素を削除する
                overlay.addEventListener('animationend', () => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(styleElement);
                });
            }
            // 初期化実行
            init();
        });
    </script>
</body>
</html>