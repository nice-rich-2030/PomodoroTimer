# FlowState プログラム仕様書

## 🔄 プログラム概要

### アーキテクチャ概念図
```
+---------------------+
|      index.html     |  ←→  ユーザーインターフェース
+----------+----------+
           ↓
+----------+----------+       +-------------------+
|    styles.css       |  ←→   |  レスポンシブ設計  |
+----------+----------+       +-------------------+
           ↓
+----------+----------+
|      app.js         |  メインアプリケーションロジック
+---------------------+
       ↓      ↓      ↓
+---------+  +---------+  +---------+
|タイマー  |  |タスク    |  |統計      |
|モジュール|  |モジュール|  |モジュール|
+---------+  +---------+  +---------+
       ↓             ↓
+----------------+  +-----------------+
|通知システ ム    |  |ローカルストレージ |
+----------------+  +-----------------+
```

### 使用技術スタック
- **フロントエンド**:
  - HTML5
  - CSS3 (アニメーション、Flexbox、Grid、変数、メディアクエリ)
  - JavaScript (ES6+)
- **ストレージ**:
  - ブラウザのローカルストレージAPI
- **通知**:
  - Web Notifications API
- **その他**:
  - SVG (グラフ描画)
  - Web Audio API (通知音)

### 依存関係
- 外部ライブラリなし（ピュアJavaScript実装）
- ブラウザ標準API
  - localStorage
  - Notification API
  - requestAnimationFrame
  - Date API

## 🧩 プログラム構造

### モジュール構成

```
FlowState/
├── index.html        # HTMLメインドキュメント
├── css/
│   └── styles.css    # スタイルシート
└── js/
    └── app.js        # アプリケーションロジック
```

### クラス階層
```
app.js
├── TimerManager     # タイマー管理クラス
├── TaskManager      # タスク管理クラス
├── StatisticsManager # 統計管理クラス
├── UIController     # UI操作クラス
├── NotificationManager # 通知管理クラス
└── StorageManager   # ストレージ管理クラス
```

### データフロー
1. **初期化フロー**:
   - ローカルストレージからデータ読み込み
   - UIの初期化とイベントリスナーの設定
   - タイマーのリセット
   - タスクリストの描画
   - 統計データの表示

2. **タイマー操作フロー**:
   - ユーザーの操作（開始/一時停止/リセット）
   - タイマー状態の更新
   - UIの更新（時間表示、プログレスバー）
   - タイマー終了時の処理（モード切替、通知）
   - 統計データの更新と保存

3. **タスク管理フロー**:
   - タスクの追加/削除/完了
   - タスクリストの更新と描画
   - タスク状態のローカルストレージへの保存
   - タスク統計の更新

4. **統計データフロー**:
   - 日別データの収集と追跡
   - 週間データの管理と古いデータの削除
   - グラフ描画と表示
   - 日付変更時のデータ更新

## 📝 関数一覧

### 主要関数の概要表

| 関数名 | 目的 | モジュール |
|--------|------|------------|
| `init()` | アプリケーション初期化 | メイン |
| `loadFromLocalStorage()` | 保存データの読み込み | ストレージ |
| `saveToLocalStorage()` | データの保存 | ストレージ |
| `startTimer()` | タイマー開始 | タイマー |
| `pauseTimer()` | タイマー一時停止 | タイマー |
| `resetTimer()` | タイマーリセット | タイマー |
| `updateTimer()` | タイマー状態更新 | タイマー |
| `renderTasks()` | タスクリスト描画 | タスク |
| `updateTasksCounter()` | タスク数更新 | タスク |
| `updateStatisticsDisplay()` | 統計表示更新 | 統計 |
| `drawWeeklyChart()` | 週間グラフ描画 | 統計 |
| `checkDateChange()` | 日付変更確認 | 統計 |
| `notifyTimerEnd()` | タイマー終了通知 | 通知 |
| `setupEventListeners()` | イベントリスナー設定 | UI |

### 公開API/インターフェース

- **タイマーインターフェース**:
  - `startTimer()`
  - `pauseTimer()`
  - `resetTimer()`

- **タスク管理インターフェース**:
  - `addTask(text, plannedPomodoros)`
  - `completeTask(id)`
  - `deleteTask(id)`
  - `reorderTasks(orderedIds)`

- **統計インターフェース**:
  - `getPomodoroStats(dateRange)`
  - `getCompletedTasksCount(dateRange)`
  - `getFocusTimeStats(dateRange)`

- **設定インターフェース**:
  - `updateSettings(workTime, breakTime)`
  - `toggleTheme(isDark)`
  - `toggleFocusMode(isEnabled)`

## 📄 関数詳細

### 各関数の詳細仕様

#### タイマー管理関数

**`startTimer()`**
- **目的**: タイマーを開始または再開する
- **パラメータ**: なし
- **動作**: 
  1. 現在時刻を取得し、終了予定時刻を計算
  2. タイマー状態を「実行中」に設定
  3. インターバルを設定して定期的に更新
  4. UIの状態を更新（ボタン、ステータス表示）
- **戻り値**: なし
- **例外処理**: すでに実行中の場合は何もしない

**`pauseTimer()`**
- **目的**: 実行中のタイマーを一時停止する
- **パラメータ**: なし
- **動作**:
  1. インターバルをクリア
  2. 残り時間を計算して保存
  3. タイマー状態を「停止中」に設定
  4. UIの状態を更新
- **戻り値**: なし
- **例外処理**: 実行中でない場合は何もしない

**`resetTimer()`**
- **目的**: タイマーを初期状態に戻す
- **パラメータ**: なし
- **動作**:
  1. タイマーを停止
  2. タイマーの状態をリセット
  3. UIの表示をリセット
  4. プログレスバーをゼロに設定
- **戻り値**: なし

**`updateTimer()`**
- **目的**: タイマーの残り時間と表示を更新する
- **パラメータ**: なし
- **動作**:
  1. 現在時刻と終了予定時刻から残り時間を計算
  2. タイマー終了判定
  3. 終了時はモード切替とカウンター更新
  4. 表示とプログレスバーの更新
- **内部アルゴリズム**: 
  ```
  if (タイマー実行中) {
    現在時刻 = 現在のタイムスタンプ
    残り時間 = 終了予定時刻 - 現在時刻
    
    if (残り時間 <= 0) {
      タイマー終了処理()
      モード切替()
      統計更新()
      return
    }
    
    表示更新(残り時間)
    プログレスバー更新(進捗率)
  }
  ```

#### タスク管理関数

**`renderTasks()`**
- **目的**: タスクリストをUIに描画する
- **パラメータ**: なし
- **動作**:
  1. タスクリスト要素をクリア
  2. 表示/非表示フィルタリング適用
  3. 各タスクのHTML要素を生成
  4. イベントリスナー（チェック、削除、ドラッグ）を設定
- **戻り値**: なし

**`updateTasksCounter()`**
- **目的**: 全タスク数と完了タスク数の表示を更新
- **パラメータ**: なし
- **動作**:
  1. 全タスク数をカウント
  2. 完了済みタスク数をカウント
  3. UI表示を更新
- **戻り値**: なし

#### 統計管理関数

**`updateStatisticsDisplay()`**
- **目的**: 統計情報の表示を更新する
- **パラメータ**: なし
- **動作**:
  1. 今日の日付のデータを取得
  2. ポモドーロ数、集中時間、完了タスク数を表示
- **戻り値**: なし

**`drawWeeklyChart()`**
- **目的**: 週間データをSVGグラフとして描画
- **パラメータ**: なし
- **動作**:
  1. SVG要素を初期化
  2. グラフサイズと余白を計算
  3. 週間データをソート
  4. 軸とラベルを描画
  5. データポイントに基づいてバーを描画
- **戻り値**: なし
- **内部アルゴリズム**:
  ```
  SVGをクリア()
  if (データ無し) {
    「データなし」メッセージ表示
    return
  }
  
  データをソート()
  最大値を計算()
  軸を描画()
  
  各データポイントについて {
    バーの高さ = 値 / 最大値 * グラフの高さ
    バーを描画(x座標, y座標, 幅, 高さ)
    ラベルを描画(日付, 値)
  }
  ```

**`checkDateChange()`**
- **目的**: 日付変更を確認し、必要に応じてデータ構造を更新
- **パラメータ**: なし
- **動作**:
  1. 現在の日付を取得
  2. 前回記録された日付と比較
  3. 日付が変わっていれば新しいエントリを追加
  4. 7日分を超えるデータを削除
  5. 統計表示を更新
- **戻り値**: なし

#### 通知関数

**`notifyTimerEnd()`**
- **目的**: タイマー終了時に通知を表示する
- **パラメータ**: なし
- **動作**:
  1. 音声通知を再生
  2. デスクトップ通知を表示
  3. 画面をフラッシュさせる視覚的通知
- **戻り値**: なし

**`showNotification()`**
- **目的**: デスクトップ通知を表示する
- **パラメータ**: なし
- **動作**:
  1. 通知権限を確認
  2. 権限があれば通知を作成
  3. 権限なければ権限リクエスト
- **戻り値**: なし
- **例外処理**: ローカル環境では通知を無効化

**`flashScreen()`**
- **目的**: 画面をフラッシュさせる視覚的通知
- **パラメータ**: なし
- **動作**:
  1. オーバーレイ要素を作成
  2. アニメーション用スタイルを設定
  3. DOMに追加
  4. アニメーション終了後に要素を削除
- **戻り値**: なし